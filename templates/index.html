<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {margin:0;padding:0;box-sizing:border-box;}
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #0b0f1a);
            color: var(--tg-theme-text-color, #ffffff);
            min-height: 100vh;
            padding: 20px;
        }
        .container {max-width: 400px;margin: 0 auto;text-align: center;}
        .header {margin-bottom: 20px;}
        .header h1 {font-size: 22px;margin-bottom: 10px;}
        .status {
            font-size: 16px;
            margin: 10px 0 20px;
            padding: 10px;
            border-radius: 10px;
            background: var(--tg-theme-secondary-bg-color, #1a2238);
        }
        .controls {margin: 10px 0 20px;display:flex;flex-wrap:wrap;justify-content:center;gap:10px;}
        .btn {
            background: var(--tg-theme-button-color, #6d5bff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            min-width: 130px;
        }
        .btn:disabled {opacity:0.5;cursor:not-allowed;}

        .game-id {
            margin: 10px 0 20px;
            padding: 10px;
            background: var(--tg-theme-secondary-bg-color, #1a2238);
            border-radius: 10px;
            font-family: monospace;
            font-size:14px;
            display:none;
        }

        .board {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px auto;
            max-width: 300px;
        }
        .cell {
            aspect-ratio: 1;
            background: var(--tg-theme-secondary-bg-color, #1a2238);
            border: none;
            border-radius: 10px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }
        .cell.x { color: #ff3b30; }
        .cell.o { color: #0af; }
        .cell:disabled {opacity:.4;cursor:not-allowed;}

        #newGameBtn {display:none;}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéÆ –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</h1>
        <div id="status" class="status">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π</div>
    </div>

    <div class="controls">
        <button class="btn" id="createBtn">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
        <button class="btn" id="joinBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        <button class="btn" id="shareBtn" disabled>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>

    <div id="gameIdBox" class="game-id">
        ID –∏–≥—Ä—ã: <span id="gameIdText"></span>
    </div>

    <div id="board" class="board"></div>

    <div class="controls">
        <button class="btn" id="newGameBtn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    </div>
</div>

<script>
    const tg = window.Telegram?.WebApp;
    if (tg) {
        tg.expand();
        tg.ready();
    }

    let currentGameId = null;
    let currentPlayer = null;
    let userId = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id)
        ? tg.initDataUnsafe.user.id
        : Math.random().toString(36).substr(2,9);

    // –≤–∞–∂–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:
    // —Ñ—Ä–æ–Ω—Ç —Ç–µ–ø–µ—Ä—å —Å—Ç—É—á–∏—Ç –≤ —Ç–æ—Ç –∂–µ –¥–æ–º–µ–Ω, –≥–¥–µ –∫—Ä—É—Ç–∏—Ç—Å—è Flask
    const API_BASE = "https://tggame-4.onrender.comgit add .
git commit -m "fix: update API and enable CORS for Telegram WebApp"
git push origin main
";

    const statusEl = document.getElementById('status');
    const boardEl  = document.getElementById('board');
    const gameIdBox= document.getElementById('gameIdBox');
    const gameIdText=document.getElementById('gameIdText');
    const shareBtn = document.getElementById('shareBtn');
    const newGameBtn=document.getElementById('newGameBtn');
    const createBtn=document.getElementById('createBtn');
    const joinBtn  =document.getElementById('joinBtn');

    createBtn.onclick = createGame;
    joinBtn.onclick   = promptJoin;
    shareBtn.onclick  = shareGame;
    newGameBtn.onclick= resetLocal;

    function setStatus(msg) {
        statusEl.textContent = msg;
    }

    function promptJoin() {
        const gid = prompt("–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä—ã:");
        if (!gid) return;
        joinGame(gid);
    }

    async function createGame() {
        try {
            const res = await fetch(`${API_BASE}/api/game/new`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'}
            });
            const data = await res.json();
            if (!data.success) {
                setStatus("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã");
                return;
            }
            currentGameId = data.gameId;
            gameIdText.textContent = currentGameId;
            gameIdBox.style.display = 'block';
            shareBtn.disabled = false;

            await joinGame(currentGameId, true); // –∞–≤—Ç–æ-–≤—Ö–æ–¥ —Å–æ–∑–¥–∞—Ç–µ–ª—è
            setStatus("–ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞. –ñ–¥—ë–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞‚Ä¶");
        } catch (e) {
            console.error(e);
            setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏");
        }
    }

    async function joinGame(gameId, isCreator=false) {
        try {
            const res = await fetch(`${API_BASE}/api/game/${gameId}/join`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ userId })
            });
            const data = await res.json();
            if (!data.success) {
                setStatus(data.error || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è");
                return;
            }
            currentGameId = gameId;
            currentPlayer = data.player;
            initBoard();
            pollState(); // –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–ª–∏–Ω–≥
            setStatus(`–¢—ã –∏–≥—Ä–∞–µ—à—å –∑–∞ ${currentPlayer === 'X' ? '‚ùå' : '‚≠ï'}`);
            gameIdText.textContent = currentGameId;
            gameIdBox.style.display = 'block';
            shareBtn.disabled = false;
            newGameBtn.style.display = 'inline-block';
        } catch (e) {
            console.error(e);
            setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∏–≥—Ä—É");
        }
    }

    function initBoard() {
        boardEl.innerHTML = "";
        boardEl.style.display = 'grid';
        // –¥–µ–ª–∞–µ–º 9 –∫–Ω–æ–ø–æ–∫
        for (let r=0; r<3; r++){
            for (let c=0; c<3; c++){
                const btn=document.createElement("button");
                btn.className="cell";
                btn.dataset.row=r;
                btn.dataset.col=c;
                btn.onclick = () => doMove(r,c);
                boardEl.appendChild(btn);
            }
        }
    }

    async function doMove(row,col) {
        if (!currentGameId || !currentPlayer) return;
        try {
            const res = await fetch(`${API_BASE}/api/game/${currentGameId}/move`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    row: row,
                    col: col,
                    player: currentPlayer
                })
            });
            const data = await res.json();
            if (data.success) {
                renderState(data.gameState);
            } else {
                // –Ω–∞–ø—Ä–∏–º–µ—Ä "–Ω–µ —Ç–≤–æ–π —Ö–æ–¥"
                if (data.error) setStatus(data.error);
            }
        } catch (e) {
            console.error(e);
        }
    }

    function renderState(state){
        // –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–ª–µ—Ç–∫–∏
        const cells = boardEl.getElementsByClassName('cell');
        let idx=0;
        for (let r=0;r<3;r++){
            for (let c=0;c<3;c++){
                const val = state.board[r][c]; // '' | X | O
                const el = cells[idx++];
                el.textContent = val === 'X' ? '‚ùå' : val === 'O' ? '‚≠ï' : '';
                el.className = 'cell ' + val.toLowerCase();
                el.disabled = (val !== '' || state.gameOver);
            }
        }

        if (state.gameOver) {
            if (state.winner === null || state.winner === undefined) {
                setStatus("ü§ù –ù–∏—á—å—è!");
            } else {
                const winMark = state.winner === 'X' ? '‚ùå' : '‚≠ï';
                setStatus(`üéâ –ü–æ–±–µ–¥–∏–ª ${winMark}`);
            }
        } else {
            const turnMark = state.currentPlayer === 'X' ? '‚ùå' : '‚≠ï';
            setStatus(`–•–æ–¥–∏—Ç ${turnMark}`);
        }
    }

    async function pollState() {
        // –ø—Ä–æ—Å—Ç–æ–π –ø–æ–ª–ª–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 2—Å–µ–∫
        setInterval(async () => {
            if (!currentGameId) return;
            try {
                const res = await fetch(`${API_BASE}/api/game/${currentGameId}`);
                const data = await res.json();
                if (data.success) {
                    renderState(data.gameState);
                }
            } catch(e){
                console.error(e);
            }
        }, 2000);
    }

    function shareGame() {
        if (currentGameId) {
            // –í –ø—Ä–æ–¥–µ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å tg.MainButton –∏–ª–∏ tg.showPopup().
            alert("–û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É ID –∏–≥—Ä—ã: " + currentGameId);
        }
    }

    function resetLocal() {
        currentGameId = null;
        currentPlayer = null;
        boardEl.style.display = 'none';
        boardEl.innerHTML = '';
        gameIdBox.style.display = 'none';
        shareBtn.disabled = true;
        newGameBtn.style.display = 'none';
        setStatus("–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π");
    }

    // init
    setStatus("–ì–æ—Ç–æ–≤ –∫ –∏–≥—Ä–µ");
</script>
</body>
</html>
